<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Community - Modern Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111b21;
            color: #e9edef;
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            position: relative;
        }

        /* Header with gradient and status */
        .header {
            background: #202c33;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            color: #aebac1;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
        }

        .chat-title {
            font-weight: 500;
            font-size: 1.1rem;
        }

        .chat-status {
            font-size: 0.8rem;
            color: #8696a0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #00a884;
        }

        .header-right {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }

        .header-right i {
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Search bar */
        .search-container {
            background: #202c33;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
        }

        .search-bar {
            width: 100%;
            padding: 10px 16px;
            border-radius: 20px;
            background-color: #2a3942;
            border: none;
            outline: none;
            color: #e9edef;
            font-family: 'Roboto', sans-serif;
        }

        .search-bar::placeholder {
            color: #8696a0;
        }

        /* Chat container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background-color: #0b141a;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23121d24' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Message bubbles */
        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-sender {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.85rem;
            color: #00a884;
        }

        .message-time {
            font-size: 0.7rem;
            text-align: right;
            margin-top: 4px;
            opacity: 0.6;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 3px;
        }

        .user-message {
            align-self: flex-end;
            background-color: #005c4b;
            border-top-right-radius: 0;
        }

        .other-message {
            align-self: flex-start;
            background-color: #202c33;
            border-top-left-radius: 0;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .message-group .message {
            margin-bottom: 2px;
        }

        /* Message status icons */
        .message-status {
            margin-left: 5px;
        }

        .message-status.sent {
            color: #8696a0;
        }

        .message-status.delivered {
            color: #8696a0;
        }

        .message-status.seen {
            color: #53bdeb;
        }

        /* Message reactions */
        .message-reactions {
            display: flex;
            margin-top: 5px;
            gap: 5px;
        }

        .reaction {
            background: #202c33;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .reaction-count {
            font-size: 0.6rem;
        }

        /* Reply preview */
        .reply-preview {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #00a884;
            padding: 5px 10px;
            margin-bottom: 8px;
            border-radius: 0 5px 5px 0;
            font-size: 0.85rem;
        }

        .reply-sender {
            font-weight: 500;
            color: #00a884;
        }

        .reply-text {
            color: #8696a0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Avatar */
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #00a884;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.9rem;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .message-with-avatar {
            display: flex;
            align-items: flex-start;
        }

        .message-content {
            flex: 1;
        }

        /* Pinned message */
        .pinned-message {
            background: rgba(0, 168, 132, 0.1);
            border-left: 3px solid #00a884;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
            font-size: 0.9rem;
        }

        .pinned-label {
            font-size: 0.7rem;
            color: #00a884;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Deleted message */
        .deleted-message {
            font-style: italic;
            color: #8696a0;
        }

        /* Message actions menu */
        .message-actions {
            position: absolute;
            background: #233138;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: none;
            flex-direction: column;
            padding: 5px 0;
        }

        .message-action {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-action:hover {
            background: #2a3942;
        }

        /* Group info drawer */
        .group-info-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: #202c33;
            transition: right 0.3s ease;
            z-index: 200;
            overflow-y: auto;
        }

        .group-info-drawer.open {
            right: 0;
        }

        .drawer-header {
            padding: 20px;
            background: #005c4b;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .close-drawer {
            cursor: pointer;
            font-size: 1.2rem;
        }

        .group-info-content {
            padding: 20px;
        }

        .group-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #00a884;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        .group-name {
            text-align: center;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .group-about {
            text-align: center;
            color: #8696a0;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 0.9rem;
            color: #00a884;
            margin-bottom: 15px;
        }

        .member-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .member {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .member-name {
            font-size: 1rem;
        }

        /* Input area */
        .input-container {
            padding: 10px 16px;
            background-color: #202c33;
            display: flex;
            align-items: center;
            gap: 10px;
            position: sticky;
            bottom: 0;
        }

        .input-left {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #8696a0;
        }

        .input-left i {
            font-size: 1.2rem;
            cursor: pointer;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 12px 16px;
            border-radius: 20px;
            background-color: #2a3942;
            font-family: 'Roboto', sans-serif;
            font-size: 0.95rem;
            color: #e9edef;
            transition: background-color 0.3s;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .message-input:focus {
            background-color: #2a3942;
        }

        .input-right {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #8696a0;
        }

        .input-right i {
            font-size: 1.2rem;
            cursor: pointer;
        }

        .send-button {
            background-color: #00a884;
            color: #111b21;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background-color: #06cf9c;
        }

        .send-button:active {
            background-color: #008f6b;
        }

        /* Reply input */
        .reply-input-container {
            background: #202c33;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .reply-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .reply-cancel {
            color: #00a884;
            cursor: pointer;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            font-size: 0.8rem;
            color: #8696a0;
            margin-left: 10px;
            margin-bottom: 5px;
            align-self: flex-start;
        }

        .typing-dots {
            display: flex;
            margin-left: 8px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #8696a0;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }

        /* Welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            height: 100%;
        }

        .welcome-icon {
            font-size: 4rem;
            color: #8696a0;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #e9edef;
        }

        .welcome-text {
            color: #8696a0;
            max-width: 400px;
            line-height: 1.5;
        }

        /* Search highlight */
        .search-highlight {
            background-color: rgba(0, 168, 132, 0.3);
            padding: 2px;
            border-radius: 3px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .message {
                max-width: 85%;
            }
            
            .header {
                padding: 14px;
            }
            
            .input-container {
                padding: 8px 14px;
            }
            
            .group-info-drawer {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="back-button" id="backButton">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="chat-info">
                <div class="chat-title">English Community</div>
                <div class="chat-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Online</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <i class="fas fa-search" id="searchToggle"></i>
            <i class="fas fa-info-circle" id="groupInfoToggle"></i>
        </div>
    </div>
    
    <div class="search-container" id="searchContainer">
        <input type="text" class="search-bar" id="searchInput" placeholder="Search messages...">
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="welcome-title">English Community</div>
            <div class="welcome-text">Welcome to the English Community! Discuss grammar, share essays, and improve your skills together.</div>
        </div>
        <!-- Pinned message will appear here -->
        <!-- Messages will be added here by JavaScript -->
    </div>
    
    <div class="reply-input-container" id="replyInputContainer">
        <div class="reply-info">
            <div>Replying to <span id="replyToUser"></span></div>
            <div class="reply-cancel" id="cancelReply">Cancel</div>
        </div>
        <div class="reply-preview">
            <div class="reply-sender" id="replyPreviewSender"></div>
            <div class="reply-text" id="replyPreviewText"></div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        <span id="typingUser"></span> is typing
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
    
    <div class="input-container">
        <div class="input-left">
            <i class="far fa-smile"></i>
            <i class="fas fa-paperclip"></i>
        </div>
        <input type="text" class="message-input" id="messageInput" placeholder="Type a message...">
        <div class="input-right">
            <i class="fas fa-microphone"></i>
            <button class="send-button" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Group Info Drawer -->
    <div class="group-info-drawer" id="groupInfoDrawer">
        <div class="drawer-header">
            <div class="drawer-title">Group Info</div>
            <div class="close-drawer" id="closeDrawer">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="group-info-content">
            <div class="group-avatar">E</div>
            <div class="group-name">English Community</div>
            <div class="group-about">A place to discuss English grammar, writing, and literature</div>
            
            <div class="info-section">
                <div class="section-title">MEMBERS (15)</div>
                <div class="member-list" id="memberList">
                    <!-- Members will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="info-section">
                <div class="section-title">GROUP SETTINGS</div>
                <div class="member-list">
                    <div class="member">
                        <div class="member-avatar"><i class="fas fa-bell"></i></div>
                        <div class="member-name">Notifications</div>
                    </div>
                    <div class="member">
                        <div class="member-avatar"><i class="fas fa-lock"></i></div>
                        <div class="member-name">Privacy</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get username from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get('name') || 'You';
        
        // DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const searchToggle = document.getElementById('searchToggle');
        const groupInfoDrawer = document.getElementById('groupInfoDrawer');
        const groupInfoToggle = document.getElementById('groupInfoToggle');
        const closeDrawer = document.getElementById('closeDrawer');
        const memberList = document.getElementById('memberList');
        const backButton = document.getElementById('backButton');
        const replyInputContainer = document.getElementById('replyInputContainer');
        const replyToUser = document.getElementById('replyToUser');
        const replyPreviewSender = document.getElementById('replyPreviewSender');
        const replyPreviewText = document.getElementById('replyPreviewText');
        const cancelReply = document.getElementById('cancelReply');

        // Current user
        const currentUser = {
            name: userName,
            id: "user_" + Math.random().toString(36).substr(2, 9)
        };

        // In-memory data storage
        let messages = [];
        let pinnedMessage = null;
        let replyingTo = null;
        let messageCounter = 0;

        // Dummy users for the chat
        const dummyUsers = [
            { name: "Grammar Expert", id: "user_grammar" },
            { name: "Prof. Shakespeare", id: "user_shakespeare" },
            { name: "Dr. Austen", id: "user_austen" },
            { name: "Word Wizard", id: "user_wizard" },
            { name: "Language Lover", id: "user_lover" }
        ];

        // Populate member list
        function populateMemberList() {
            // Add current user
            const currentMember = document.createElement('div');
            currentMember.className = 'member';
            currentMember.innerHTML = `
                <div class="member-avatar">${currentUser.name.charAt(0)}</div>
                <div class="member-name">${currentUser.name} (You)</div>
            `;
            memberList.appendChild(currentMember);
            
            // Add dummy users
            dummyUsers.forEach(user => {
                const member = document.createElement('div');
                member.className = 'member';
                member.innerHTML = `
                    <div class="member-avatar">${user.name.charAt(0)}</div>
                    <div class="member-name">${user.name}</div>
                `;
                memberList.appendChild(member);
            });
        }

        // Generate a unique message ID
        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + (messageCounter++);
        }

        // Add a message to the chat
        function addMessage(sender, text, timestamp, isUser, messageId, replyTo = null, status = 'sent') {
            // Remove welcome screen if it exists
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Create message object
            const message = {
                id: messageId,
                sender: sender,
                senderId: isUser ? currentUser.id : sender.replace(/\s+/g, '_').toLowerCase(),
                text: text,
                time: timestamp,
                isUser: isUser,
                status: status,
                replyTo: replyTo,
                reactions: {},
                deleted: false,
                pinned: false
            };
            
            // Add to messages array
            messages.push(message);
            
            // Create message element
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-with-avatar`;
            
            // Avatar for other users
            if (!isUser) {
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = sender.charAt(0);
                messageDiv.appendChild(avatar);
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `message ${isUser ? 'user-message' : 'other-message'}`;
            messageBubble.setAttribute('data-id', messageId);
            
            // Format the time
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Show sender name only for other users
            if (!isUser) {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = sender;
                messageBubble.appendChild(senderDiv);
            }
            
            // Add reply preview if applicable
            if (replyTo) {
                const replyPreview = document.createElement('div');
                replyPreview.className = 'reply-preview';
                replyPreview.innerHTML = `
                    <div class="reply-sender">${replyTo.sender}</div>
                    <div class="reply-text">${replyTo.text}</div>
                `;
                messageBubble.appendChild(replyPreview);
            }
            
            // Message text
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;
            messageBubble.appendChild(textDiv);
            
            // Message time and status
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            
            timeDiv.innerHTML = formattedTime;
            
            if (isUser) {
                const statusIcon = document.createElement('i');
                statusIcon.className = `message-status ${status}`;
                
                if (status === 'sent') {
                    statusIcon.className = 'fas fa-check message-status sent';
                } else if (status === 'delivered') {
                    statusIcon.className = 'fas fa-check-double message-status delivered';
                } else if (status === 'seen') {
                    statusIcon.className = 'fas fa-check-double message-status seen';
                }
                
                timeDiv.appendChild(statusIcon);
            }
            
            messageBubble.appendChild(timeDiv);
            
            // Add context menu for messages
            messageBubble.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showMessageActions(e, messageId, isUser);
            });
            
            messageContent.appendChild(messageBubble);
            
            // Add reactions container
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'message-reactions';
            reactionsDiv.setAttribute('data-message-id', messageId);
            messageContent.appendChild(reactionsDiv);
            
            messageDiv.appendChild(messageContent);
            messageGroup.appendChild(messageDiv);
            
            // Add to chat container
            chatContainer.appendChild(messageGroup);
            
            // Scroll to bottom
            scrollToBottom();
            
            // Update message status with timeouts (for user messages)
            if (isUser) {
                setTimeout(() => {
                    updateMessageStatus(messageId, 'delivered');
                }, 1000);
                
                setTimeout(() => {
                    updateMessageStatus(messageId, 'seen');
                }, 3000);
            }
            
            return message;
        }

        // Update message status
        function updateMessageStatus(messageId, status) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = status;
                
                const messageElement = document.querySelector(`[data-id="${messageId}"]`);
                if (messageElement) {
                    const timeDiv = messageElement.querySelector('.message-time');
                    const existingIcon = timeDiv.querySelector('.message-status');
                    if (existingIcon) {
                        timeDiv.removeChild(existingIcon);
                    }
                    
                    const statusIcon = document.createElement('i');
                    statusIcon.className = `message-status ${status}`;
                    
                    if (status === 'sent') {
                        statusIcon.className = 'fas fa-check message-status sent';
                    } else if (status === 'delivered') {
                        statusIcon.className = 'fas fa-check-double message-status delivered';
                    } else if (status === 'seen') {
                        statusIcon.className = 'fas fa-check-double message-status seen';
                    }
                    
                    timeDiv.appendChild(statusIcon);
                }
            }
        }

        // Show message actions menu
        function showMessageActions(e, messageId, isUser) {
            // Remove any existing actions menu
            const existingMenu = document.querySelector('.message-actions');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const message = messages.find(m => m.id === messageId);
            if (!message || message.deleted) return;
            
            const menu = document.createElement('div');
            menu.className = 'message-actions';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            
            // Add reaction options
            const reactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ”¥'];
            reactions.forEach(reaction => {
                const action = document.createElement('div');
                action.className = 'message-action';
                action.innerHTML = `${reaction} React ${reaction}`;
                action.addEventListener('click', () => {
                    addReaction(messageId, reaction);
                    menu.remove();
                });
                menu.appendChild(action);
            });
            
            // Add reply option
            const replyAction = document.createElement('div');
            replyAction.className = 'message-action';
            replyAction.innerHTML = '<i class="fas fa-reply"></i> Reply';
            replyAction.addEventListener('click', () => {
                setReplyMessage(messageId);
                menu.remove();
            });
            menu.appendChild(replyAction);
            
            // Add pin option if not already pinned
            if (!message.pinned) {
                const pinAction = document.createElement('div');
                pinAction.className = 'message-action';
                pinAction.innerHTML = '<i class="fas fa-thumbtack"></i> Pin';
                pinAction.addEventListener('click', () => {
                    pinMessage(messageId);
                    menu.remove();
                });
                menu.appendChild(pinAction);
            }
            
            // Add delete option for user's own messages
            if (isUser) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'message-action';
                deleteAction.innerHTML = '<i class="fas fa-trash"></i> Delete';
                deleteAction.addEventListener('click', () => {
                    deleteMessage(messageId);
                    menu.remove();
                });
                menu.appendChild(deleteAction);
            }
            
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        // Add reaction to a message
        function addReaction(messageId, reaction) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            if (!message.reactions[reaction]) {
                message.reactions[reaction] = [];
            }
            
            // Check if user already reacted with this emoji
            if (!message.reactions[reaction].includes(currentUser.name)) {
                message.reactions[reaction].push(currentUser.name);
                updateReactionsDisplay(messageId);
            }
        }

        // Update reactions display for a message
        function updateReactionsDisplay(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            const reactionsDiv = document.querySelector(`.message-reactions[data-message-id="${messageId}"]`);
            if (!reactionsDiv) return;
            
            // Clear existing reactions
            reactionsDiv.innerHTML = '';
            
            // Add each reaction
            Object.keys(message.reactions).forEach(reaction => {
                if (message.reactions[reaction].length > 0) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = 'reaction';
                    reactionDiv.innerHTML = `
                        ${reaction} <span class="reaction-count">${message.reactions[reaction].length}</span>
                    `;
                    reactionsDiv.appendChild(reactionDiv);
                }
            });
        }

        // Set reply message
        function setReplyMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            replyingTo = {
                id: messageId,
                sender: message.sender,
                text: message.text
            };
            
            replyToUser.textContent = message.sender;
            replyPreviewSender.textContent = message.sender;
            replyPreviewText.textContent = message.text;
            replyInputContainer.style.display = 'block';
            
            // Scroll to input
            messageInput.focus();
        }

        // Cancel reply
        function cancelReplyMessage() {
            replyingTo = null;
            replyInputContainer.style.display = 'none';
        }

        // Pin a message
        function pinMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            // Unpin previous pinned message
            if (pinnedMessage) {
                pinnedMessage.pinned = false;
                const previousPinnedElement = document.querySelector('.pinned-message');
                if (previousPinnedElement) {
                    previousPinnedElement.remove();
                }
            }
            
            // Pin new message
            message.pinned = true;
            pinnedMessage = message;
            
            // Create pinned message element
            const pinnedDiv = document.createElement('div');
            pinnedDiv.className = 'pinned-message';
            pinnedDiv.innerHTML = `
                <div class="pinned-label">
                    <i class="fas fa-thumbtack"></i> Pinned Message
                </div>
                <div class="message-sender">${message.sender}</div>
                <div class="message-text">${message.text}</div>
            `;
            
            // Insert after welcome screen or at the top
            const firstMessage = chatContainer.querySelector('.message-group') || chatContainer.querySelector('.pinned-message');
            if (firstMessage) {
                chatContainer.insertBefore(pinnedDiv, firstMessage);
            } else {
                chatContainer.appendChild(pinnedDiv);
            }
        }

        // Delete a message
        function deleteMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            message.deleted = true;
            message.text = 'This message was deleted';
            
            const messageElement = document.querySelector(`[data-id="${messageId}"]`);
            if (messageElement) {
                const textDiv = messageElement.querySelector('.message-text');
                textDiv.textContent = 'This message was deleted';
                textDiv.className = 'message-text deleted-message';
                
                // Remove reactions
                const reactionsDiv = messageElement.querySelector('.message-reactions');
                if (reactionsDiv) {
                    reactionsDiv.innerHTML = '';
                }
                
                // Remove reply preview if exists
                const replyPreview = messageElement.querySelector('.reply-preview');
                if (replyPreview) {
                    replyPreview.remove();
                }
            }
        }

        // Search messages
        function searchMessages(query) {
            if (!query) {
                // Remove highlights if search is cleared
                const highlights = document.querySelectorAll('.search-highlight');
                highlights.forEach(highlight => {
                    const parent = highlight.parentNode;
                    parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                    parent.normalize();
                });
                return;
            }
            
            // Highlight matching messages
            messages.forEach(message => {
                if (message.text.toLowerCase().includes(query.toLowerCase()) && !message.deleted) {
                    const messageElement = document.querySelector(`[data-id="${message.id}"]`);
                    if (messageElement) {
                        const textDiv = messageElement.querySelector('.message-text');
                        const text = textDiv.textContent;
                        const regex = new RegExp(`(${query})`, 'gi');
                        const highlightedText = text.replace(regex, '<span class="search-highlight">$1</span>');
                        textDiv.innerHTML = highlightedText;
                    }
                }
            });
        }

        // Send message function
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                const messageId = generateMessageId();
                const timestamp = new Date();
                
                let replyTo = null;
                if (replyingTo) {
                    replyTo = {
                        id: replyingTo.id,
                        sender: replyingTo.sender,
                        text: replyingTo.text
                    };
                }
                
                addMessage(currentUser.name, text, timestamp, true, messageId, replyTo);
                
                // Clear input and reply
                messageInput.value = '';
                cancelReplyMessage();
                
                // Simulate response from other users
                if (Math.random() < 0.3) { // 30% chance of response
                    setTimeout(() => {
                        const randomUser = dummyUsers[Math.floor(Math.random() * dummyUsers.length)];
                        const responses = [
                            "That's an interesting point!",
                            "I agree with you.",
                            "Could you explain that further?",
                            "I have a different perspective on that.",
                            "Thanks for sharing!"
                        ];
                        const response = responses[Math.floor(Math.random() * responses.length)];
                        
                        addMessage(randomUser.name, response, new Date(), false, generateMessageId());
                    }, 2000);
                }
            }
        }

        // Function to scroll to the bottom of the chat
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Typing detection variables
        let typing = false;
        let lastTypingTime = 0;
        const TYPING_TIMER_LENGTH = 1000; // 1 second
function initializeUser() {
  const storedUser = localStorage.getItem('chatUser');
  if (storedUser) {
    currentUser = JSON.parse(storedUser);
  } else {
    // Agar naam nahi mila to subject page pe bhej do
    window.location.href = "subject.html";
  }
}

        // Typing functions
        function updateTyping(typingStatus) {
            typing = typingStatus;
            
            if (typing) {
                // Update last typing time
                lastTypingTime = Date.now();
                
                // Show typing indicator for current user
                typingUser.textContent = currentUser.name;
                typingIndicator.style.display = 'flex';
            } else {
                // Hide typing indicator
                setTimeout(() => {
                    if (Date.now() - lastTypingTime >= TYPING_TIMER_LENGTH) {
                        typingIndicator.style.display = 'none';
                    }
                }, TYPING_TIMER_LENGTH);
            }
        }

        // Simulate typing from other users
        setInterval(() => {
            if (Math.random() < 0.02) { // 2% chance every second
                const randomUser = dummyUsers[Math.floor(Math.random() * dummyUsers.length)];
                
                if (randomUser.name !== currentUser.name) {
                    typingUser.textContent = randomUser.name;
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                    }, 2000);
                }
            }
        }, 1000);

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Typing detection
        messageInput.addEventListener('input', () => {
            updateTyping(true);
        });

        messageInput.addEventListener('blur', () => {
            updateTyping(false);
        });

        // Search toggle
        searchToggle.addEventListener('click', () => {
            if (searchContainer.style.display === 'block') {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                searchMessages('');
            } else {
                searchContainer.style.display = 'block';
                searchInput.focus();
            }
        });

        // Search functionality
        searchInput.addEventListener('input', () => {
            searchMessages(searchInput.value);
        });

        // Group info toggle
        groupInfoToggle.addEventListener('click', () => {
            groupInfoDrawer.classList.add('open');
        });

        closeDrawer.addEventListener('click', () => {
            groupInfoDrawer.classList.remove('open');
        });

        // Back button
        backButton.addEventListener('click', () => {
            window.history.back();
        });

        // Cancel reply
        cancelReply.addEventListener('click', cancelReplyMessage);

        // Auto-focus the input field
        messageInput.focus();

        // Initialize the chat with sample messages
        function initializeChat() {
            populateMemberList();
            
            // Add sample messages
            setTimeout(() => {
                addMessage("Grammar Expert", "Welcome to English Community! Feel free to ask any grammar or writing-related questions.", new Date(), false, generateMessageId());
                addMessage("Prof. Shakespeare", "Remember to proofread your messages and use proper punctuation for clarity.", new Date(), false, generateMessageId());
            }, 1000);
        }

        // Initialize the chat when the page loads
        window.addEventListener('DOMContentLoaded', initializeChat);
    </script>
</body>
</html>