<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch & Earn</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBzDvBjcm56XutOD0l_vOnWO0EqGrrj3dw",
            authDomain: "explore-products-e7afb.firebaseapp.com",
            projectId: "explore-products-e7afb",
            storageBucket: "explore-products-e7afb.firebasestorage.app",
            messagingSenderId: "753462167322",
            appId: "1:753462167322:web:aab56a193e231277accea3",
            measurementId: "G-T4KP9YEY4X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firestore = db;
    </script>
    
    <style>
        :root {
            --primary-green: #0a5c36;
            --dark-green: #07482a;
            --light-green: #0f7a4a;
            --gold: #d4af37;
            --light-gold: #f5e6a3;
            --white: #ffffff;
            --light-gray: #f5f5f5;
            --dark-gray: #333333;
            --error: #e74c3c;
            --success: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .balance-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            color: var(--gold);
            margin: 10px 0;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 18px;
            color: var(--gold);
        }

        .badge {
            background: var(--gold);
            color: var(--dark-green);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .streak-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .streak-day {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            position: relative;
        }

        .streak-day.active {
            background: var(--gold);
            color: var(--dark-green);
        }

        .streak-day.completed::after {
            content: "‚úì";
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--success);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn {
            background: var(--gold);
            color: var(--dark-green);
            border: none;
            border-radius: 10px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            background: var(--light-gold);
            transform: translateY(-2px);
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 14px;
        }

        .withdraw-locked {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .withdraw-locked .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .field-valid {
            border-color: var(--success);
        }

        .field-invalid {
            border-color: var(--error);
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 38px;
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .withdraw-amounts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .amount-option {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .amount-option.selected {
            background: var(--gold);
            color: var(--dark-green);
            font-weight: bold;
        }

        .withdraw-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .history-info p {
            font-size: 12px;
            opacity: 0.8;
        }

        .history-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .status-processing {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .status-paid {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-rejected {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .history-actions button {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--primary-green);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--gold);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: var(--gold);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-footer .btn {
            flex: 1;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-green);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--gold);
            opacity: 0;
            z-index: 999;
        }

        .admin-link {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--white);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            text-decoration: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 92, 54, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-text {
            color: var(--gold);
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner" style="width: 40px; height: 40px;"></div>
        <div class="loading-text">Loading your rewards...</div>
    </div>

    <div class="container">
        <header>
            <div class="logo">Watch & Earn</div>
            <p>Watch ads, earn rewards, and withdraw your earnings!</p>
        </header>

        <div class="balance-card">
            <p>Your Balance</p>
            <div class="balance-amount" id="balance">‚Ç®0.00</div>
            <p>Complete the 7-day streak to unlock withdrawals</p>
        </div>

        <div class="section">
            <div class="section-title">
                <span>Daily Challenge</span>
                <span class="badge" id="streak-badge">Day 1</span>
            </div>
            <p>Watch 100 ads daily to maintain your streak</p>
            
            <div class="streak-container" id="streak-days">
                <!-- Streak days will be populated by JS -->
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-text">0/100 ads watched</span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            
            <button class="btn" id="watch-ad-btn">
                <span>Watch Ad & Earn</span>
            </button>
        </div>

        <div class="section" id="withdraw-section">
            <div class="section-title">
                <span>Withdraw Earnings</span>
                <span class="badge" id="withdraw-badge">LOCKED</span>
            </div>
            
            <div class="withdraw-locked" id="withdraw-locked">
                <div class="icon">üîí</div>
                <h3>Withdrawals Locked</h3>
                <p>Complete 7 consecutive days of the daily challenge to unlock withdrawals</p>
                <p id="streak-progress">Current streak: 0 days</p>
            </div>
            
            <div id="withdraw-unlocked" style="display: none;">
                <div class="withdraw-locked" style="background: rgba(212, 175, 55, 0.1);">
                    <div class="icon">üéâ</div>
                    <h3>Withdrawals Unlocked!</h3>
                    <p>You can now withdraw your earnings</p>
                    <button class="btn" id="enter-details-btn">Enter Withdraw Details</button>
                </div>
                
                <div id="withdraw-details-form" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">Withdraw Details</h3>
                    
                    <div class="form-group">
                        <label for="full-name">Full Name *</label>
                        <input type="text" id="full-name" placeholder="Enter your full name">
                        <div class="error-message" id="full-name-error">Please enter your full name</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" placeholder="03XX-XXXXXXX">
                        <div class="error-message" id="phone-error">Please enter a valid phone number</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="method">Withdrawal Method *</label>
                        <select id="method">
                            <option value="">Select method</option>
                            <option value="easypaisa">Easypaisa</option>
                            <option value="jazzcash">JazzCash</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                        <div class="error-message" id="method-error">Please select a withdrawal method</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="account">Account / Mobile Number *</label>
                        <div style="position: relative;">
                            <input type="text" id="account" placeholder="Enter account/mobile number">
                            <button type="button" class="toggle-password" id="toggle-account">üëÅÔ∏è</button>
                        </div>
                        <div class="error-message" id="account-error">Please enter a valid account/mobile number</div>
                    </div>
                    
                    <div id="bank-fields" style="display: none;">
                        <div class="form-group">
                            <label for="bank-name">Bank Name *</label>
                            <input type="text" id="bank-name" placeholder="Enter bank name">
                            <div class="error-message" id="bank-name-error">Please enter bank name</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="branch">Branch (Optional)</label>
                            <input type="text" id="branch" placeholder="Enter branch name">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cnic">CNIC (Optional)</label>
                        <input type="text" id="cnic" placeholder="XXXXX-XXXXXXX-X">
                    </div>
                    
                    <button class="btn" id="save-details-btn">
                        <span>Save Details</span>
                    </button>
                </div>
                
                <div id="withdraw-request" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">Request Withdrawal</h3>
                    
                    <div class="form-group">
                        <label>Select Amount (Min: ‚Ç®100)</label>
                        <div class="withdraw-amounts">
                            <div class="amount-option" data-amount="100">‚Ç®100</div>
                            <div class="amount-option" data-amount="500">‚Ç®500</div>
                            <div class="amount-option" data-amount="1000">‚Ç®1000</div>
                            <div class="amount-option" data-amount="2000">‚Ç®2000</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="custom-amount">Or Enter Custom Amount</label>
                        <input type="number" id="custom-amount" placeholder="Enter amount (min ‚Ç®100)" min="100">
                        <div class="error-message" id="amount-error">Amount must be at least ‚Ç®100 and not exceed your balance</div>
                    </div>
                    
                    <div class="form-group" id="saved-details-summary" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                        <!-- Saved details will be displayed here -->
                    </div>
                    
                    <button class="btn" id="request-withdraw-btn">
                        <span>Request Withdrawal</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <span>Withdrawal History</span>
            </div>
            
            <div class="withdraw-history" id="withdraw-history">
                <!-- History items will be populated by JS -->
                <div style="text-align: center; padding: 20px; opacity: 0.7;">
                    No withdrawal history yet
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="confirm-withdraw-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Withdrawal</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="confirm-details">
                <!-- Confirmation details will be populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-withdraw">Cancel</button>
                <button class="btn" id="confirm-withdraw">Confirm Withdrawal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Success!</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                <p id="success-message">Your withdrawal request has been submitted successfully!</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="close-success">OK</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Confetti -->
    <div id="confetti-container"></div>

    <!-- Admin Link (hidden by default) -->
    <a href="#" class="admin-link" id="admin-link" style="display: none;">Admin</a>

    <script type="module">
        // Import Firebase functions
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzDvBjcm56XutOD0l_vOnWO0EqGrrj3dw",
            authDomain: "explore-products-e7afb.firebaseapp.com",
            projectId: "explore-products-e7afb",
            storageBucket: "explore-products-e7afb.firebasestorage.app",
            messagingSenderId: "753462167322",
            appId: "1:753462167322:web:aab56a193e231277accea3",
            measurementId: "G-T4KP9YEY4X"
        };

        // Get device ID or generate one
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // App State
        const state = {
            deviceId: getDeviceId(),
            balance: 0,
            streak: 0,
            totalWatchedToday: 0,
            lastWatchDate: null,
            totalEarned: 0,
            withdrawDetails: null,
            withdrawHistory: [],
            isWithdrawUnlocked: false
        };

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            balance: document.getElementById('balance'),
            streakBadge: document.getElementById('streak-badge'),
            streakDays: document.getElementById('streak-days'),
            progressFill: document.getElementById('progress-fill'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            watchAdBtn: document.getElementById('watch-ad-btn'),
            withdrawSection: document.getElementById('withdraw-section'),
            withdrawBadge: document.getElementById('withdraw-badge'),
            withdrawLocked: document.getElementById('withdraw-locked'),
            withdrawUnlocked: document.getElementById('withdraw-unlocked'),
            enterDetailsBtn: document.getElementById('enter-details-btn'),
            withdrawDetailsForm: document.getElementById('withdraw-details-form'),
            withdrawRequest: document.getElementById('withdraw-request'),
            saveDetailsBtn: document.getElementById('save-details-btn'),
            requestWithdrawBtn: document.getElementById('request-withdraw-btn'),
            withdrawHistory: document.getElementById('withdraw-history'),
            confirmWithdrawModal: document.getElementById('confirm-withdraw-modal'),
            successModal: document.getElementById('success-modal'),
            toast: document.getElementById('toast'),
            confettiContainer: document.getElementById('confetti-container'),
            adminLink: document.getElementById('admin-link')
        };

        // Form Elements
        const formElements = {
            fullName: document.getElementById('full-name'),
            phone: document.getElementById('phone'),
            method: document.getElementById('method'),
            account: document.getElementById('account'),
            bankName: document.getElementById('bank-name'),
            branch: document.getElementById('branch'),
            cnic: document.getElementById('cnic'),
            customAmount: document.getElementById('custom-amount'),
            bankFields: document.getElementById('bank-fields'),
            toggleAccount: document.getElementById('toggle-account'),
            savedDetailsSummary: document.getElementById('saved-details-summary')
        };

        // Error Elements
        const errorElements = {
            fullName: document.getElementById('full-name-error'),
            phone: document.getElementById('phone-error'),
            method: document.getElementById('method-error'),
            account: document.getElementById('account-error'),
            bankName: document.getElementById('bank-name-error'),
            amount: document.getElementById('amount-error')
        };

        // Constants
        const DAILY_ADS_TARGET = 100;
        const MIN_WITHDRAW_AMOUNT = 100;
        const EARNING_PER_AD = 10; // ‚Ç®10 per ad

        // Initialize Firebase and app
        async function init() {
            try {
                // Load user data from Firebase
                await loadUserData();
                
                // Set up real-time listener for balance updates
                setupRealtimeListener();
                
                // Render UI
                renderUI();
                setupEventListeners();
                
                // Hide loading overlay
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                }, 1000);
                
                // Check if admin mode should be enabled
                if (localStorage.getItem('isAdmin') === 'true') {
                    elements.adminLink.style.display = 'block';
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error loading data. Please check your connection.', 'error');
                
                // Hide loading overlay even if there's an error
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                }, 1000);
            }
        }

        // Load user data from Firebase
        async function loadUserData() {
            const db = window.firestore;
            const userDocRef = doc(db, 'users', state.deviceId);
            
            try {
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Update state with Firebase data
                    state.balance = userData.balance || 0;
                    state.streak = userData.streak || 0;
                    state.totalWatchedToday = userData.totalWatchedToday || 0;
                    state.lastWatchDate = userData.lastWatchDate || null;
                    state.totalEarned = userData.totalEarned || 0;
                    
                    // Check if we need to reset daily progress
                    const today = new Date().toDateString();
                    if (state.lastWatchDate !== today) {
                        // If last watch was not today, check if streak should be reset
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (state.lastWatchDate !== yesterday.toDateString()) {
                            // If last watch was not yesterday, reset streak
                            state.streak = 0;
                        }
                        
                        // Reset daily progress
                        state.totalWatchedToday = 0;
                        state.lastWatchDate = today;
                        
                        // Save updated state to Firebase
                        await updateBalanceInFirestore(0); // Just update the date and reset daily progress
                    }
                } else {
                    // Create new user document
                    await setDoc(userDocRef, {
                        balance: 0,
                        streak: 0,
                        totalWatchedToday: 0,
                        lastWatchDate: new Date().toDateString(),
                        totalEarned: 0,
                        deviceId: state.deviceId,
                        createdAt: new Date().toISOString()
                    });
                }
                
                // Check if withdraw is unlocked
                state.isWithdrawUnlocked = state.streak >= 7;
                
                // Load withdraw details from localStorage
                const savedDetails = localStorage.getItem('withdrawDetails');
                if (savedDetails) {
                    state.withdrawDetails = JSON.parse(savedDetails);
                }
                
                // Load withdraw history from localStorage
                const savedHistory = localStorage.getItem('withdrawHistory');
                if (savedHistory) {
                    state.withdrawHistory = JSON.parse(savedHistory);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // Set up real-time listener for balance updates
        function setupRealtimeListener() {
            const db = window.firestore;
            const userDocRef = doc(db, 'users', state.deviceId);
            
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    
                    // Update state with latest data
                    state.balance = userData.balance || 0;
                    state.streak = userData.streak || 0;
                    state.totalWatchedToday = userData.totalWatchedToday || 0;
                    state.totalEarned = userData.totalEarned || 0;
                    
                    // Check if withdraw is unlocked
                    state.isWithdrawUnlocked = state.streak >= 7;
                    
                    // Update UI
                    renderUI();
                }
            });
        }

        // Update balance in Firestore
        async function updateBalanceInFirestore(amountToAdd = 0) {
            const db = window.firestore;
            const userDocRef = doc(db, 'users', state.deviceId);
            
            try {
                // Update state
                state.balance += amountToAdd;
                state.totalEarned += amountToAdd;
                state.totalWatchedToday += amountToAdd > 0 ? 1 : 0;
                state.lastWatchDate = new Date().toDateString();
                
                // Check if we completed today's challenge
                if (amountToAdd > 0 && state.totalWatchedToday === DAILY_ADS_TARGET) {
                    state.streak++;
                    state.isWithdrawUnlocked = state.streak >= 7;
                }
                
                // Update Firestore
                await updateDoc(userDocRef, {
                    balance: state.balance,
                    streak: state.streak,
                    totalWatchedToday: state.totalWatchedToday,
                    lastWatchDate: state.lastWatchDate,
                    totalEarned: state.totalEarned,
                    lastUpdated: new Date().toISOString()
                });
                
                return true;
            } catch (error) {
                console.error('Error updating balance:', error);
                showToast('Error updating balance. Please try again.', 'error');
                return false;
            }
        }

        // Render the UI based on current state
        function renderUI() {
            // Update balance
            elements.balance.textContent = `‚Ç®${state.balance.toFixed(2)}`;
            
            // Update streak badge
            elements.streakBadge.textContent = `Day ${state.streak + 1}`;
            
            // Render streak days
            renderStreakDays();
            
            // Update progress
            const progressPercent = (state.totalWatchedToday / DAILY_ADS_TARGET) * 100;
            elements.progressFill.style.width = `${progressPercent}%`;
            elements.progressText.textContent = `${state.totalWatchedToday}/${DAILY_ADS_TARGET} ads watched`;
            elements.progressPercent.textContent = `${Math.round(progressPercent)}%`;
            
            // Update withdraw section
            if (state.isWithdrawUnlocked) {
                elements.withdrawBadge.textContent = 'UNLOCKED';
                elements.withdrawBadge.style.background = 'var(--success)';
                elements.withdrawLocked.style.display = 'none';
                elements.withdrawUnlocked.style.display = 'block';
                
                // Show appropriate section based on whether details are saved
                if (state.withdrawDetails) {
                    elements.withdrawDetailsForm.style.display = 'none';
                    elements.withdrawRequest.style.display = 'block';
                    renderSavedDetailsSummary();
                } else {
                    elements.withdrawDetailsForm.style.display = 'block';
                    elements.withdrawRequest.style.display = 'none';
                }
            } else {
                elements.withdrawBadge.textContent = 'LOCKED';
                elements.withdrawBadge.style.background = 'var(--error)';
                elements.withdrawLocked.style.display = 'block';
                elements.withdrawUnlocked.style.display = 'none';
                
                // Update streak progress text
                document.getElementById('streak-progress').textContent = 
                    `Current streak: ${state.streak} days (need ${7 - state.streak} more)`;
            }
            
            // Render withdraw history
            renderWithdrawHistory();
            
            // Pre-fill form if details exist
            if (state.withdrawDetails) {
                formElements.fullName.value = state.withdrawDetails.fullName || '';
                formElements.phone.value = state.withdrawDetails.phone || '';
                formElements.method.value = state.withdrawDetails.method || '';
                formElements.account.value = state.withdrawDetails.account || '';
                formElements.bankName.value = state.withdrawDetails.bankName || '';
                formElements.branch.value = state.withdrawDetails.branch || '';
                formElements.cnic.value = state.withdrawDetails.cnic || '';
                
                // Show bank fields if method is bank
                if (state.withdrawDetails.method === 'bank') {
                    formElements.bankFields.style.display = 'block';
                }
            }
        }

        // Render streak days visualization
        function renderStreakDays() {
            elements.streakDays.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'streak-day';
                
                if (i < state.streak) {
                    dayElement.classList.add('completed');
                } else if (i === state.streak) {
                    dayElement.classList.add('active');
                }
                
                dayElement.textContent = i + 1;
                elements.streakDays.appendChild(dayElement);
            }
        }

        // Render saved details summary
        function renderSavedDetailsSummary() {
            if (!state.withdrawDetails) return;
            
            const { fullName, method, account } = state.withdrawDetails;
            const maskedAccount = account ? `****${account.slice(-4)}` : '';
            
            formElements.savedDetailsSummary.innerHTML = `
                <h4>Withdrawal Details</h4>
                <p><strong>Name:</strong> ${fullName}</p>
                <p><strong>Method:</strong> ${method.charAt(0).toUpperCase() + method.slice(1)}</p>
                <p><strong>Account:</strong> ${maskedAccount}</p>
                <button class="btn btn-secondary" id="edit-details-btn" style="margin-top: 10px;">Edit Details</button>
            `;
            
            // Add event listener for edit button
            document.getElementById('edit-details-btn').addEventListener('click', () => {
                elements.withdrawRequest.style.display = 'none';
                elements.withdrawDetailsForm.style.display = 'block';
            });
        }

        // Render withdraw history
        function renderWithdrawHistory() {
            if (state.withdrawHistory.length === 0) {
                elements.withdrawHistory.innerHTML = `
                    <div style="text-align: center; padding: 20px; opacity: 0.7;">
                        No withdrawal history yet
                    </div>
                `;
                return;
            }
            
            elements.withdrawHistory.innerHTML = '';
            
            state.withdrawHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item fade-in';
                    
                    const date = new Date(item.timestamp).toLocaleDateString();
                    const maskedAccount = `****${item.account.slice(-4)}`;
                    const statusClass = `status-${item.status.toLowerCase()}`;
                    
                    historyItem.innerHTML = `
                        <div class="history-info">
                            <h4>‚Ç®${item.amount.toFixed(2)}</h4>
                            <p>${item.method} ‚Ä¢ ${maskedAccount} ‚Ä¢ ${date}</p>
                        </div>
                        <div class="history-status ${statusClass}">${item.status}</div>
                        ${item.status === 'Pending' ? 
                            `<div class="history-actions">
                                <button class="cancel-withdraw" data-id="${item.id}">Cancel</button>
                            </div>` : ''
                        }
                    `;
                    
                    elements.withdrawHistory.appendChild(historyItem);
                });
            
            // Add event listeners for cancel buttons
            document.querySelectorAll('.cancel-withdraw').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    cancelWithdrawRequest(id);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Watch ad button
            elements.watchAdBtn.addEventListener('click', watchAd);
            
            // Withdraw method change
            formElements.method.addEventListener('change', handleMethodChange);
            
            // Save details button
            elements.saveDetailsBtn.addEventListener('click', saveWithdrawDetails);
            
            // Amount options
            document.querySelectorAll('.amount-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    // Remove selected class from all options
                    document.querySelectorAll('.amount-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    e.target.classList.add('selected');
                    
                    // Set custom amount value
                    formElements.customAmount.value = e.target.getAttribute('data-amount');
                    
                    // Validate amount
                    validateAmount();
                });
            });
            
            // Custom amount input
            formElements.customAmount.addEventListener('input', validateAmount);
            
            // Request withdraw button
            elements.requestWithdrawBtn.addEventListener('click', requestWithdrawal);
            
            // Toggle account visibility
            formElements.toggleAccount.addEventListener('click', () => {
                const type = formElements.account.getAttribute('type');
                formElements.account.setAttribute('type', type === 'password' ? 'text' : 'password');
            });
            
            // Form validation on input
            formElements.fullName.addEventListener('input', () => validateField('fullName'));
            formElements.phone.addEventListener('input', () => validateField('phone'));
            formElements.method.addEventListener('change', () => validateField('method'));
            formElements.account.addEventListener('input', () => validateField('account'));
            formElements.bankName.addEventListener('input', () => validateField('bankName'));
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cancel withdraw button
            document.getElementById('cancel-withdraw').addEventListener('click', () => {
                elements.confirmWithdrawModal.style.display = 'none';
            });
            
            // Confirm withdraw button
            document.getElementById('confirm-withdraw').addEventListener('click', confirmWithdrawal);
            
            // Close success modal
            document.getElementById('close-success').addEventListener('click', () => {
                elements.successModal.style.display = 'none';
            });
            
            // Admin link
            elements.adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                showAdminPanel();
            });
        }

        // Handle withdraw method change
        function handleMethodChange() {
            if (formElements.method.value === 'bank') {
                formElements.bankFields.style.display = 'block';
            } else {
                formElements.bankFields.style.display = 'none';
            }
        }

        // Watch ad function
        function watchAd() {
            // Show loading state
            elements.watchAdBtn.innerHTML = '<span class="spinner"></span> Loading Ad...';
            elements.watchAdBtn.disabled = true;
            
            // Call Android interface to show rewarded ad
            if (typeof Android !== 'undefined' && Android.showRewardedAd) {
                Android.showRewardedAd();
            } else {
                // For testing in browser (simulate ad completion)
                console.log('Android interface not available, simulating ad...');
                setTimeout(() => {
                    onAdWatchedSuccessfully();
                }, 2000);
            }
        }

        // Called when ad is successfully watched (from Android WebView)
        async function onAdWatchedSuccessfully() {
            try {
                // Update balance in Firestore
                const success = await updateBalanceInFirestore(EARNING_PER_AD);
                
                if (success) {
                    // Reset button state
                    elements.watchAdBtn.innerHTML = '<span>Watch Ad & Earn</span>';
                    elements.watchAdBtn.disabled = false;
                    
                    // Show confetti if streak milestone reached
                    if (state.streak === 7) {
                        createConfetti();
                        showToast('Congratulations! Withdrawals unlocked!', 'success');
                    } else if (state.streak % 7 === 0 && state.streak > 0) {
                        createConfetti();
                        showToast(`Amazing! ${state.streak} day streak!`, 'success');
                    }
                    
                    // Show success message
                    showToast(`+‚Ç®${EARNING_PER_AD.toFixed(2)} earned!`, 'success');
                } else {
                    // Reset button state if there was an error
                    elements.watchAdBtn.innerHTML = '<span>Watch Ad & Earn</span>';
                    elements.watchAdBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error updating balance after ad:', error);
                elements.watchAdBtn.innerHTML = '<span>Watch Ad & Earn</span>';
                elements.watchAdBtn.disabled = false;
                showToast('Error updating balance. Please try again.', 'error');
            }
        }

        // Validate form field
        function validateField(fieldName) {
            let isValid = true;
            let errorMessage = '';
            
            switch (fieldName) {
                case 'fullName':
                    if (!formElements.fullName.value.trim()) {
                        isValid = false;
                        errorMessage = 'Please enter your full name';
                    }
                    break;
                    
                case 'phone':
                    const phoneRegex = /^03[0-9]{2}-?[0-9]{7}$/;
                    if (!formElements.phone.value.trim()) {
                        isValid = false;
                        errorMessage = 'Please enter your phone number';
                    } else if (!phoneRegex.test(formElements.phone.value.replace(/-/g, ''))) {
                        isValid = false;
                        errorMessage = 'Please enter a valid phone number (03XX-XXXXXXX)';
                    }
                    break;
                    
                case 'method':
                    if (!formElements.method.value) {
                        isValid = false;
                        errorMessage = 'Please select a withdrawal method';
                    }
                    break;
                    
                case 'account':
                    if (!formElements.account.value.trim()) {
                        isValid = false;
                        errorMessage = 'Please enter your account/mobile number';
                    } else if (formElements.method.value === 'easypaisa' || formElements.method.value === 'jazzcash') {
                        const accountRegex = /^03[0-9]{2}-?[0-9]{7}$/;
                        if (!accountRegex.test(formElements.account.value.replace(/-/g, ''))) {
                            isValid = false;
                            errorMessage = 'Please enter a valid mobile number (03XX-XXXXXXX)';
                        }
                    }
                    break;
                    
                case 'bankName':
                    if (formElements.method.value === 'bank' && !formElements.bankName.value.trim()) {
                        isValid = false;
                        errorMessage = 'Please enter bank name';
                    }
                    break;
            }
            
            // Update UI
            if (isValid) {
                formElements[fieldName].classList.remove('field-invalid');
                formElements[fieldName].classList.add('field-valid');
                errorElements[fieldName].style.display = 'none';
            } else {
                formElements[fieldName].classList.remove('field-valid');
                formElements[fieldName].classList.add('field-invalid');
                errorElements[fieldName].textContent = errorMessage;
                errorElements[fieldName].style.display = 'block';
            }
            
            return isValid;
        }

        // Validate all form fields
        function validateForm() {
            const fields = ['fullName', 'phone', 'method', 'account'];
            if (formElements.method.value === 'bank') {
                fields.push('bankName');
            }
            
            let isValid = true;
            fields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Validate withdrawal amount
        function validateAmount() {
            const amount = parseFloat(formElements.customAmount.value) || 0;
            let isValid = true;
            let errorMessage = '';
            
            if (amount < MIN_WITHDRAW_AMOUNT) {
                isValid = false;
                errorMessage = `Amount must be at least ‚Ç®${MIN_WITHDRAW_AMOUNT}`;
            } else if (amount > state.balance) {
                isValid = false;
                errorMessage = 'Insufficient balance';
            }
            
            // Update UI
            if (isValid) {
                formElements.customAmount.classList.remove('field-invalid');
                formElements.customAmount.classList.add('field-valid');
                errorElements.amount.style.display = 'none';
            } else {
                formElements.customAmount.classList.remove('field-valid');
                formElements.customAmount.classList.add('field-invalid');
                errorElements.amount.textContent = errorMessage;
                errorElements.amount.style.display = 'block';
            }
            
            return isValid;
        }

        // Save withdraw details
        function saveWithdrawDetails() {
            // Show loading state
            elements.saveDetailsBtn.innerHTML = '<span class="spinner"></span> Saving...';
            elements.saveDetailsBtn.disabled = true;
            
            // Validate form
            if (!validateForm()) {
                elements.saveDetailsBtn.innerHTML = '<span>Save Details</span>';
                elements.saveDetailsBtn.disabled = false;
                showToast('Please fix errors in the form', 'error');
                return;
            }
            
            // Create details object
            const details = {
                fullName: formElements.fullName.value.trim(),
                phone: formElements.phone.value.trim(),
                method: formElements.method.value,
                account: formElements.account.value.trim(),
                bankName: formElements.bankName.value.trim(),
                branch: formElements.branch.value.trim(),
                cnic: formElements.cnic.value.trim()
            };
            
            // Save to state and localStorage
            state.withdrawDetails = details;
            localStorage.setItem('withdrawDetails', JSON.stringify(details));
            
            // Call Android interface if available
            if (typeof Android !== 'undefined' && Android.saveWithdrawDetails) {
                Android.saveWithdrawDetails(JSON.stringify(details));
            }
            
            // Update UI
            renderUI();
            
            // Reset button state
            elements.saveDetailsBtn.innerHTML = '<span>Save Details</span>';
            elements.saveDetailsBtn.disabled = false;
            
            // Show success message
            showToast('Details saved successfully!', 'success');
        }

        // Request withdrawal
        function requestWithdrawal() {
            // Validate amount
            if (!validateAmount()) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const amount = parseFloat(formElements.customAmount.value);
            
            // Show confirmation modal
            const confirmDetails = document.getElementById('confirm-details');
            const maskedAccount = `****${state.withdrawDetails.account.slice(-4)}`;
            
            confirmDetails.innerHTML = `
                <p><strong>Amount:</strong> ‚Ç®${amount.toFixed(2)}</p>
                <p><strong>Method:</strong> ${state.withdrawDetails.method.charAt(0).toUpperCase() + state.withdrawDetails.method.slice(1)}</p>
                <p><strong>Account:</strong> ${maskedAccount}</p>
                <p><strong>Fee:</strong> ‚Ç®0.00</p>
                <p><strong>Total Receive:</strong> ‚Ç®${amount.toFixed(2)}</p>
            `;
            
            elements.confirmWithdrawModal.style.display = 'flex';
        }

        // Confirm withdrawal
        async function confirmWithdrawal() {
            const amount = parseFloat(formElements.customAmount.value);
            
            // Create withdraw request
            const request = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                amount: amount,
                method: state.withdrawDetails.method,
                account: state.withdrawDetails.account,
                status: 'Pending'
            };
            
            // Add to history
            state.withdrawHistory.push(request);
            localStorage.setItem('withdrawHistory', JSON.stringify(state.withdrawHistory));
            
            // Update balance in Firestore
            try {
                const db = window.firestore;
                const userDocRef = doc(db, 'users', state.deviceId);
                
                await updateDoc(userDocRef, {
                    balance: state.balance - amount
                });
                
                // Update local state
                state.balance -= amount;
                
                // Call Android interface if available
                if (typeof Android !== 'undefined' && Android.submitWithdraw) {
                    Android.submitWithdraw(JSON.stringify(request));
                }
                
                // Close modal and show success
                elements.confirmWithdrawModal.style.display = 'none';
                
                document.getElementById('success-message').textContent = 
                    `Your withdrawal request for ‚Ç®${amount.toFixed(2)} has been submitted successfully!`;
                elements.successModal.style.display = 'flex';
                
                // Update UI
                renderUI();
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showToast('Error processing withdrawal. Please try again.', 'error');
            }
        }

        // Cancel withdraw request
        function cancelWithdrawRequest(id) {
            const request = state.withdrawHistory.find(item => item.id === id);
            if (!request || request.status !== 'Pending') return;
            
            // Update status to Cancelled
            request.status = 'Cancelled';
            
            // Refund balance
            state.balance += request.amount;
            
            // Save state
            localStorage.setItem('withdrawHistory', JSON.stringify(state.withdrawHistory));
            
            // Update UI
            renderUI();
            
            // Show message
            showToast('Withdrawal request cancelled', 'success');
        }

        // Show toast message
        function showToast(message, type = 'success') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type}`;
            elements.toast.style.display = 'flex';
            
            setTimeout(() => {
                elements.toast.style.display = 'none';
            }, 3000);
        }

        // Create confetti animation
        function createConfetti() {
            elements.confettiContainer.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                // Random position, color, and animation
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = `${Math.random() * 100}%`;
                confetti.style.background = i % 3 === 0 ? 'var(--gold)' : i % 3 === 1 ? 'var(--light-green)' : 'var(--white)';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // Random size
                const size = Math.random() * 10 + 5;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                
                elements.confettiContainer.appendChild(confetti);
                
                // Animate
                setTimeout(() => {
                    confetti.style.opacity = '1';
                    confetti.style.transition = 'all 1s ease';
                    confetti.style.transform = `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`;
                }, 10);
                
                // Remove after animation
                setTimeout(() => {
                    confetti.remove();
                }, 1000);
            }
        }

        // Show admin panel (for testing)
        function showAdminPanel() {
            const adminHTML = `
                <div class="modal" id="admin-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Admin Panel</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div>
                            <h4>Withdrawal Requests</h4>
                            <div id="admin-requests" style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                                <!-- Admin requests will be populated here -->
                            </div>
                            
                            <h4>Actions</h4>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn" id="add-balance-btn">Add ‚Ç®100</button>
                                <button class="btn btn-secondary" id="reset-app-btn">Reset App</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add admin modal to page
            document.body.insertAdjacentHTML('beforeend', adminHTML);
            
            // Render admin requests
            renderAdminRequests();
            
            // Setup admin event listeners
            document.getElementById('add-balance-btn').addEventListener('click', async () => {
                try {
                    await updateBalanceInFirestore(100);
                    showToast('‚Ç®100 added to balance', 'success');
                } catch (error) {
                    showToast('Error adding balance', 'error');
                }
            });
            
            document.getElementById('reset-app-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset the app? All data will be lost.')) {
                    localStorage.clear();
                    location.reload();
                }
            });
            
            document.querySelector('#admin-modal .close-modal').addEventListener('click', () => {
                document.getElementById('admin-modal').remove();
            });
        }

        // Render admin requests
        function renderAdminRequests() {
            const adminRequests = document.getElementById('admin-requests');
            
            if (state.withdrawHistory.length === 0) {
                adminRequests.innerHTML = '<p style="text-align: center; opacity: 0.7;">No withdrawal requests</p>';
                return;
            }
            
            adminRequests.innerHTML = '';
            
            state.withdrawHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(item => {
                    const requestElement = document.createElement('div');
                    requestElement.className = 'history-item';
                    requestElement.style.marginBottom = '10px';
                    
                    const date = new Date(item.timestamp).toLocaleString();
                    const statusOptions = ['Pending', 'Processing', 'Paid', 'Rejected'];
                    let statusSelect = '';
                    
                    if (item.status === 'Pending' || item.status === 'Processing') {
                        statusSelect = `
                            <select class="status-select" data-id="${item.id}">
                                ${statusOptions.map(opt => 
                                    `<option value="${opt}" ${opt === item.status ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else {
                        statusSelect = `<span class="history-status status-${item.status.toLowerCase()}">${item.status}</span>`;
                    }
                    
                    requestElement.innerHTML = `
                        <div class="history-info">
                            <h4>‚Ç®${item.amount.toFixed(2)}</h4>
                            <p>${item.method} ‚Ä¢ ${item.account} ‚Ä¢ ${date}</p>
                        </div>
                        ${statusSelect}
                    `;
                    
                    adminRequests.appendChild(requestElement);
                });
            
            // Add event listeners for status changes
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const newStatus = e.target.value;
                    
                    // Update status in history
                    const request = state.withdrawHistory.find(item => item.id === id);
                    if (request) {
                        request.status = newStatus;
                        localStorage.setItem('withdrawHistory', JSON.stringify(state.withdrawHistory));
                        
                        // If status is Paid or Rejected, we might need to update balance
                        if (newStatus === 'Rejected' && request.status !== 'Rejected') {
                            // Refund balance if request was previously approved
                            state.balance += request.amount;
                            localStorage.setItem('watchEarnState', JSON.stringify(state));
                        }
                        
                        // Update UI
                        renderUI();
                        renderAdminRequests();
                        
                        showToast(`Request status updated to ${newStatus}`, 'success');
                    }
                });
            });
        }

        // Make onAdWatchedSuccessfully available globally for Android WebView
        window.onAdWatchedSuccessfully = onAdWatchedSuccessfully;

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script>
document.getElementById("watch-ad-btn").addEventListener("click", () => {
    if (window.AndroidInterface) {
        // üëâ Ask Android to show Rewarded Ad
        AndroidInterface.showRewardAd();
    } else {
        alert("‚ö†Ô∏è App not connected to Android interface");
    }
});

// ‚úÖ Called automatically by Android when reward earned
function onRewardEarned() {
    // üí∞ Reward logic ‚Äî update your UI, balance, etc.
    const badge = document.getElementById("withdraw-badge");
    badge.innerText = "UNLOCKED";
    badge.style.backgroundColor = "#28a745";

    // Optional visual feedback
    alert("üéâ You‚Äôve earned your reward!");
}
</script>

</body>
</html>
